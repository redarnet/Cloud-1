---
- name: Cr√©er dossier Nginx
  file:
    path: /opt/wordpress/nginx
    state: directory
    mode: '0755'

- name: Cr√©er le sous-dossier conf.d pour Nginx
  file:
    path: /opt/wordpress/nginx/conf.d
    state: directory
    mode: '0755'

- name: Cr√©er dossier pour les certificats SSL
  file:
    path: /opt/wordpress/nginx/certs
    state: directory
    mode: '0755'

- name: V√©rifier si le certificat SSL existe d√©j√†
  stat:
    path: /opt/wordpress/nginx/certs/nginx-selfsigned.crt
  register: ssl_cert

- name: G√©n√©rer un certificat SSL auto-sign√©
  command: >
    openssl req -x509 -nodes -days 365 -newkey rsa:2048
    -keyout /opt/wordpress/nginx/certs/nginx-selfsigned.key
    -out /opt/wordpress/nginx/certs/nginx-selfsigned.crt
    -subj "/C=FR/ST=IDF/L=Paris/O=Dev/CN={{ nginx_domain }}"
  when: not ssl_cert.stat.exists

- name: Configurer les permissions du certificat
  file:
    path: "{{ item }}"
    mode: '0600'
    owner: root
    group: root
  loop:
    - /opt/wordpress/nginx/certs/nginx-selfsigned.key
    - /opt/wordpress/nginx/certs/nginx-selfsigned.crt
  when: not ssl_cert.stat.exists

- name: Copier la configuration Nginx pour WordPress
  template:
    src: nginx.conf.j2
    dest: /opt/wordpress/nginx/conf.d/default.conf
    mode: '0644'
  notify: Red√©marrer Nginx

- name: Cr√©er dossier pour Certbot
  file:
    path: /var/www/certbot
    state: directory
    mode: '0755'

- name: Configurer /etc/hosts pour le domaine local
  lineinfile:
    path: /etc/hosts
    line: "127.0.0.1 {{ nginx_domain }}"
    state: present
    regexp: '^127\.0\.0\.1\s+{{ nginx_domain }}$'

- name: Configurer /etc/hosts pour le sous-domaine phpMyAdmin
  lineinfile:
    path: /etc/hosts
    line: "127.0.0.1 {{ nginx_phpmyadmin_subdomain }}"
    state: present
    regexp: '^127\.0\.0\.1\s+{{ nginx_phpmyadmin_subdomain }}$'

- name: Lancer le conteneur Nginx
  community.docker.docker_compose_v2:
    project_src: "{{ wordpress_dir }}"
    services:
      - nginx
    state: present

- name: Afficher les URLs d'acc√®s
  debug:
    msg:
      - "‚úÖ WordPress accessible sur : https://{{ nginx_domain }} ou https://192.168.56.10"
      - "‚úÖ phpMyAdmin accessible sur : https://{{ nginx_phpmyadmin_subdomain }}"
      - "‚ö†Ô∏è  Certificat auto-sign√© : ton navigateur affichera un avertissement de s√©curit√©"
      - "üí° Accepte l'exception de s√©curit√© dans ton navigateur pour continuer"
---
- name: Installation Docker Compose et d√©ploiement WordPress
  hosts: local
  become: yes
  vars:
    wordpress_dir: "/opt/wordpress"
    project_dir: "{{ playbook_dir }}"

  tasks:
    - name: Mise √† jour du cache apt
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Installation des d√©pendances
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
      when: ansible_os_family == "Debian"

    - name: Ajout de la cl√© GPG Docker pour Debian
      apt_key:
        url: https://download.docker.com/linux/debian/gpg
        state: present
      when: ansible_distribution == "Debian"

    - name: Ajout du d√©p√¥t Docker pour Debian
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
        state: present
      when: ansible_distribution == "Debian"

    - name: Ajout de la cl√© GPG Docker pour Ubuntu
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
      when: ansible_distribution == "Ubuntu"

    - name: Ajout du d√©p√¥t Docker pour Ubuntu
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
      when: ansible_distribution == "Ubuntu"

    - name: Installation de Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: D√©marrage et activation de Docker
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Installer docker-compose
      apt:
        name: docker-compose
        state: present
        update_cache: yes

    - name: Cr√©er le dossier de l'application
      file:
        path: "{{ wordpress_dir }}"
        state: directory
        mode: '0755'

    - name: Copier le docker-compose.yml
      copy:
        src: "{{ project_dir }}/docker-compose.yml"
        dest: "{{ wordpress_dir }}/docker-compose.yml"
        mode: '0644'
      register: compose_file_changed

    - name: Copier le fichier .env
      copy:
        src: "{{ project_dir }}/.env"
        dest: "{{ wordpress_dir }}/.env"
        mode: '0600'
      register: env_file_changed

    - name: V√©rifier si les conteneurs WordPress existent d√©j√†
      shell: docker ps -a --filter "name=wordpress" --format "{{`{{.Names}}`}}"
      register: existing_containers
      changed_when: false
      failed_when: false

    - name: Afficher l'√©tat actuel
      debug:
        msg: "Conteneurs existants: {{ existing_containers.stdout_lines }}"

    - name: Arr√™ter les conteneurs si fichiers modifi√©s
      shell: docker-compose down
      args:
        chdir: "{{ wordpress_dir }}"
      when: 
        - existing_containers.stdout_lines | length > 0
        - (compose_file_changed.changed or env_file_changed.changed)
      failed_when: false

    - name: Lancer WordPress avec docker-compose
      shell: docker-compose up -d --remove-orphans
      args:
        chdir: "{{ wordpress_dir }}"
      register: compose_output
      changed_when: "'Creating' in compose_output.stderr or 'Starting' in compose_output.stderr"

    - name: Afficher le r√©sultat du docker-compose
      debug:
        msg: "{{ compose_output.stderr_lines | default([]) }}"

    - name: Attendre que les conteneurs soient pr√™ts
      pause:
        seconds: 15
      when: compose_output.changed

    - name: V√©rification de l'√©tat des conteneurs
      shell: docker ps --filter "name=wordpress" --format "table {{`{{.Names}}\t{{.Status}}\t{{.Ports}}`}}"
      register: docker_ps
      changed_when: false

    - name: Affichage des conteneurs en cours d'ex√©cution
      debug:
        var: docker_ps.stdout_lines

    - name: V√©rifier que WordPress r√©pond
      uri:
        url: http://localhost:8080
        status_code: [200, 302]
      register: wordpress_check
      retries: 5
      delay: 3
      until: wordpress_check.status in [200, 302]
      ignore_errors: yes

    - name: V√©rifier que PHPMyAdmin r√©pond
      uri:
        url: http://localhost:8081
        status_code: [200, 302]
      register: phpmyadmin_check
      retries: 5
      delay: 3
      until: phpmyadmin_check.status in [200, 302]
      ignore_errors: yes

    - name: Message de succ√®s
      debug:
        msg: 
          - "=========================================="
          - "‚úì Installation termin√©e avec succ√®s !"
          - "=========================================="
          - ""
          - "üì¶ Services disponibles :"
          - "  ‚Ä¢ WordPress    : http://localhost:8080"
          - "  ‚Ä¢ PHPMyAdmin   : http://localhost:8081"
          - "  ‚Ä¢ MySQL        : localhost:3306"
          - ""
          - "üîë Connexion PHPMyAdmin :"
          - "  ‚Ä¢ Serveur      : db"
          - "  ‚Ä¢ Utilisateur  : {{ lookup('env', 'MYSQL_USER') | default('wordpress', true) }}"
          - "  ‚Ä¢ Mot de passe : (voir fichier .env)"
          - ""
          - "üìÇ Donn√©es persist√©es dans : {{ wordpress_dir }}"
          - ""
          - "üõ†Ô∏è  Commandes utiles :"
          - "  ‚Ä¢ Arr√™ter      : cd {{ wordpress_dir }} && docker-compose down"
          - "  ‚Ä¢ Red√©marrer   : cd {{ wordpress_dir }} && docker-compose restart"
          - "  ‚Ä¢ Voir logs    : cd {{ wordpress_dir }} && docker-compose logs -f"
          - "  ‚Ä¢ Reset complet: cd {{ wordpress_dir }} && docker-compose down -v"
          - "=========================================="